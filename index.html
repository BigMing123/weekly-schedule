<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<link href='lib/main.css' rel='stylesheet' />
<link href='lib/common.css' rel='stylesheet' />
<link href='lib/student-interface.css' rel='stylesheet' />
<script src='lib/main.js'></script>
<script src='lib/locales/zh-cn.js'></script>
<script src="lib/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/faunadb@latest/dist/faunadb.js"></script>
<script src="lib/fauna-api.js"></script>
<script src="lib/wxpusher-api.js"></script>
<script>
  let eventsData = [];
  let hiddenDays = [];
  let calendar = null;
  let selectedSlots = [];
  let startISOstr = null;
  let endISOstr = null;
  let code = "";
  let uid = "";
  let studentname = ""; //测试值
  let contact = "";
  let targetscore = "";
  const maxCourseCount = 5; //最多一次选课多少节
  const monthStart = new Date(new Date().setMonth(new Date().getMonth()));
  const monthEnd = new Date(new Date().setMonth(new Date().getMonth() + 1));
  const monthEndOneDayExtra = new Date(monthEnd.getTime() + 86400000); //结尾多一天
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
      locale: zhCn,
      initialDate: '2020-09-12',
      initialView: 'timeGridWeek',
      nowIndicator: true,
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'timeGridWeek'
      },
      eventClick: function(info) {
        let dbId = info.event.extendedProps.dbId;
        let start = info.event._instance.range.start;
        let end = info.event._instance.range.end;
        let title = info.event.title;
        let event = {};
        for (let i = 0; i < eventsData.length; i++) {
          if (eventsData[i].dbId === dbId) {
            if (eventsData[i].status === 'selectable') {
              if (selectedSlots.length > maxCourseCount - 1) {
                return;
              }
              selectedSlots.push(dbId);
              eventsData[i].status = 'selected';
              eventsData[i].color = '#cc8e31';
              eventsData[i].title = '已选择';
            } else if (eventsData[i].status === 'selected'){  
              selectedSlots.splice(selectedSlots.indexOf(dbId), 1);
              eventsData[i].status = 'selectable';
              eventsData[i].color = '#29b80d';
              eventsData[i].title = '';
            }
            event = eventsData[i];
          }
        }
        let newEvents = JSON.parse(JSON.stringify(eventsData));
        calendar.setOption('events', newEvents);
        calendar.render();
      },
      navLinks: true, // can click day/week names to navigate views
      editable: false,
      selectable: false,
      selectMirror: true,
      dayMaxEvents: true, // allow "more" link when too many events
      events: eventsData,
      select: function(event) {
        let start = event.start;
        let end = event.end;
        startTime = event.start;
        endTime = event.end;
      },
      selectOverlap : false,
      validRange: {
          // start: new Date(new Date().setDate(new Date().getDate() - 6)),
          // end: new Date(new Date().setDate(new Date().getDate() + 30))
          start: monthStart,
          end: monthEnd
      },
      hiddenDays: [],   //设置不可选的工作日，1,3 代表周一周三 0代表周日
      slotMinTime: '07:00:00',
      slotMaxTime: '22:00:00'
    });
    prepareISOstr();
    prepareSubmitForm();
    prepareLoginForm();

    //测试代码
    // document.getElementById("qr-code-panel").setAttribute("style","display:none");
    // showLoader();
    // loadPanel();
  });

  function loadPanel() {
    let linkNode = document.getElementsByTagName('link')[1];
    linkNode.disabled = true;
    document.getElementById("login-panel").setAttribute("style", "display:none");
    prepareClientInterfaceEvents(0);
  }

  function hideLoader() {
    let loader = document.getElementById("loader-1");
    loader.setAttribute("style","display: none;");
    let calendarEle = document.getElementById("calendar");
    calendarEle.setAttribute("style", "display: block");
  }

  function showLoader() {
    let loader = document.getElementById("loader-1");
    loader.setAttribute("style","display: block;");
    let calendar = document.getElementById("calendar");
    calendar.setAttribute("style", "display: none");
  }

  function setupSubmitBtn() {
    let topEle = document.getElementsByClassName("fc-header-toolbar fc-toolbar fc-toolbar-ltr")[0];
    let submitBtn = document.createElement("button");
    submitBtn.innerHTML = "提交选课";
    submitBtn.className = "fc-timeGridWeek-button fc-button fc-button-primary fc-button-active";
    topEle.appendChild(submitBtn);
    submitBtn.setAttribute("onclick", "onSubmit()");
  }

  function onSubmit(){
    if (selectedSlots.length === 0) {
      return;
    }
    let studentnameEle = document.getElementById("studentname");
    let contactEle = document.getElementById("contact");
    let tsEle = document.getElementById("targetscore");
    let courseprofileEle =document.getElementById("course-profile");

    studentnameEle.innerHTML = studentname;
    contactEle.innerHTML = contact;
    tsEle.setAttribute("value", targetscore);

    displayCourseInfo(courseprofileEle);
    displaySubmitPanel();
  }

  function displayCourseInfo(courseElement) {
    removeAllChildNode(courseElement);
    let listFirstItem = document.createElement("li");
    listFirstItem.innerHTML = "预约时间(北京时间):";
    courseElement.appendChild(listFirstItem);
    eventsData.map(ele => {
      if (selectedSlots.includes(ele.dbId)) {
        let listItem = document.createElement("li");
        let courseinfo = new Date(ele.start).toLocaleString("zh-cn") + ' - ' + new Date(ele.end).toLocaleString("zh-cn");
        listItem.innerHTML = courseinfo;
        courseElement.appendChild(listItem);

      }
    })
  }

  function displaySubmitPanel() {
    let calendar = document.getElementById("calendar");
    calendar.setAttribute("style", "display: none");
    let linkNode = document.getElementsByTagName('link')[1];
    linkNode.disabled = false;
    let bookPanel = document.getElementById("book-panel");
    bookPanel.setAttribute("style", "display: block");
  }

  function removeAllChildNode(parent) {
    while (parent.firstChild) {
        parent.removeChild(parent.firstChild);
    }
  }

  function prepareLoginForm() {
    const form = document.getElementById('login-form');
    form.addEventListener('submit', (event) => {
      event.preventDefault();
      studentname = event.srcElement[0].value;
      contact = event.srcElement[1].value;
      targetscore = event.srcElement[2].value;
      login();
    });
  }

  function login() {
    let student = {student_uid: uid, student_name: studentname, contact: contact, targetscore: targetscore};
    faunaAddStudent(student)
    .then(res => {
      if (JSON.stringify(res) !== JSON.stringify({})) {
        showLoader();
        loadPanel();
      }
    })


    faunaFindItemByValue('user', 'username', username)
    .then((res) => {
      if (Object.keys(res).length != 0) {
        let pw = res.data.password;
        let linkNode = document.getElementsByTagName('link')[1];
        linkNode.disabled = true;
        prepareUserProfile(tutorname);
        loadPanel();
      } else {
        appendAlertInfo("登陆失败，用户名密码不正确");
        loginPanel.setAttribute("style","display:block");
        loader.setAttribute("style","display:none");
      }
    });
  }

  function returnBack() {
    selectedSlots = [];
    let bookPanel = document.getElementById("book-panel");
    bookPanel.setAttribute("style", "display: none");

    let linkNode = document.getElementsByTagName('link')[1];
    linkNode.disabled = true;

    showLoader();
    prepareClientInterfaceEvents(1);
  }

  function isValid(str){
    return !/[~`!#$%\^&*+=\-\[\]\\';,/{}|\\":<>\?]/g.test(str);
  }

  function prepareSubmitForm() {
    const form = document.getElementById('submit-form');
    form.addEventListener('submit', (event) => {
      event.preventDefault();
      let targetScore = event.srcElement[0].value;
      let courseType = event.srcElement[1].value;
      submitBooking(targetScore, courseType);
    });
  }

  function submitBooking(targetScore, courseType) {
    let contactWay = contact;
    let loader = document.getElementById("loader-2");
    let submitBtn = document.getElementById("save-btn");
    submitBtn.setAttribute("style", "display:none");
    loader.setAttribute("style", "display:block");

    let selectedEvents = [];
    eventsData.map(event => {
      if (selectedSlots.includes(event.dbId)) {
        selectedEvents.push(event);
      }
    })

    avoidDoubleBook(selectedEvents)
    .then(res => {
      if (res) {
        let successfulCount = 0;
        let timeStrs = [];
        selectedEvents.map(selectedEvent => {
          var newEvent = {
            title: "",
            contact: contact,
            start: selectedEvent.start,
            end: selectedEvent.end,
            student_name: studentname,
            course_type: courseType,
            target_score: targetScore
          };
          faunaBookEvent(newEvent).then(res => {
            if (JSON.stringify(res.data) !== JSON.stringify({})) {
              successfulCount += 1;
              let s = new Date(res.data.start.value).toLocaleString("zh-cn");
              let e = new Date(res.data.end.value).toLocaleString("zh-cn");
              let studentName = res.data.student_name;
              let courseType = res.data.course_type;
              let timestr = `${s}-${e}`;
              timeStrs.push(timestr);
              if (successfulCount === selectedEvents.length) {
                let timeStr = timeStrs.join(", ");
                let strStudent = `${studentName}同学, 您成功预约了${timeStr}的${courseType}课程, 如需变更, 请联系领洋客服进行处理`;
                let strTutor = `${studentName}成功预约了${timeStr}的${courseType}课程, 目标分: ${res.data.target_score}, 联系方式: ${res.data.contact}`;
                pushWxMessage(uid, strStudent);
                sendTutorMsg(strTutor);
              }
            }
            submitBtn.setAttribute("style", "display:block");
            loader.setAttribute("style", "display:none");
            selectedSlots = [];
            returnBack();
          })
        })
      } else {
        alert("预约时间段已被占用,请重新选择");
        submitBtn.setAttribute("style", "display:block");
        loader.setAttribute("style", "display:none");
        selectedSlots = [];
        returnBack();
      }
    })
  }

  function sendTutorMsg(msg) {
    faunaGetTutors()
    .then(tutors => {
      tutors.map(tutor => {
        pushWxMessage(tutor.data.uid, msg);
      })
    })
  }

  async function avoidDoubleBook(selectedEvents) {
    return new Promise(resolve => {
      faunaGetBookedEventsCurrentMonth(startISOstr, endISOstr)
      .then(events => {
        let flag = true;
        events.map(event => {
          let newEvent = JSON.parse(JSON.stringify(event));
          selectedEvents.map(selectedEvent => {
            newEvent.data.start = event.data.start.value;
            newEvent.data.end = event.data.end.value;
            if (checkTimeOverlap(newEvent.data, selectedEvent)) {
              flag = false;
            }
          })
        })
        return resolve(flag);
      })
    })
  }

  function checkTimeOverlap(event, selectedEvent) {
    let timeOverlap = false;
    let s = new Date(event.start);
    let e = new Date(event.end);
    let start = new Date(selectedEvent.start); 
    let end = new Date(selectedEvent.end);
    if (start < e && start >= s) {
      timeOverlap = true;
    }
    if (end <= e && end > s) {
      timeOverlap = true;
    }
    return timeOverlap;
  }

  function prepareISOstr() {
    startISOstr = new Date(monthStart.getTime());
    startISOstr.setHours(0);
    startISOstr.setMinutes(0);
    startISOstr.setSeconds(0);
    startISOstr = startISOstr.toISOString();
    endISOstr = new Date(monthEndOneDayExtra.getTime());
    endISOstr.setHours(0);
    endISOstr.setMinutes(0);
    endISOstr.setSeconds(0);
    endISOstr = endISOstr.toISOString();
  }

  async function prepareClientInterfaceEvents(option) {
    return new Promise(resolve => {
      faunaGetEventsCurrentMonth(startISOstr, endISOstr)
      .then(adminEvents => {
        faunaGetBookedEventsCurrentMonth(startISOstr, endISOstr)
        .then(bookedEvents => {
          finaliseClientInterfaceEvents(adminEvents, bookedEvents, option);
        })
      })
    })
  }

  function finaliseClientInterfaceEvents(adminEvents, bookedEvents, option) {
    let clsEvents = [];
    let selectables = [];
    let unSelectables = [];
    adminEvents.map(adminEvent => {
      let selectable = true;
      let newEvent = {};
      if (bookedEvents.length === 0) {
        let ae = JSON.parse(JSON.stringify(adminEvent.data));
        ae.start = adminEvent.data.start.value;
        ae.end = adminEvent.data.end.value;
        newEvent = JSON.parse(JSON.stringify(ae));
        newEvent.dbId = adminEvent.ref.id;
      } else {
        bookedEvents.map(bookedEvent => {
          let ae = JSON.parse(JSON.stringify(adminEvent.data));
          let be = JSON.parse(JSON.stringify(bookedEvent.data));
          ae.start = adminEvent.data.start.value;
          ae.end = adminEvent.data.end.value;
          be.start = bookedEvent.data.start.value;
          be.end = bookedEvent.data.end.value;
          newEvent = JSON.parse(JSON.stringify(ae));
          newEvent.dbId = adminEvent.ref.id;
          if (checkTimeOverlap(ae, be)) {
            selectable = false;
          } 
        })
      }
      if (selectable) {
        newEvent.color = "#29b80d";
        newEvent.status = "selectable";
        clsEvents.push(newEvent);
      } else {
        newEvent.color = "#bababa";
        newEvent.status = "unSelectable";
        clsEvents.push(newEvent);
      }
    })
    eventsData = JSON.parse(JSON.stringify(clsEvents));
    hideLoader();
    calendar.setOption('events', clsEvents);
    calendar.render();
    if (option === 0) {
      setupSubmitBtn();
    }
  }

  function createQrCodeHtml() {
    document.getElementById("loader-1").setAttribute("style", "display: block"); 
    document.getElementById('login-btn-ini').setAttribute("style", "display: none");
    document.getElementById("login-panel-title").setAttribute("style", "display:none");
    createQrCode()
    .then(res => {
      document.getElementById("qr-code").setAttribute("src",res.url);
      code = res.code;
      constantQuery();
    })
    .catch(err => {
      qrCodeNotLoaded();
    })
  }

  function qrCodeLoaded() {
    document.getElementById("loader-1").setAttribute("style", "display: none"); 
    document.getElementById("qr-info").setAttribute("style", "display:block");
    document.getElementById("login-panel-title").setAttribute("style", "display:block;margin-bottom:-30px");
    document.getElementById("wechat-icon").setAttribute("style","display:block; position:relative; top:150px;");
    document.getElementById("login-btn-ini").setAttribute("style","display:none");
  }

  function qrCodeNotLoaded() {
    document.getElementById("loader-1").setAttribute("style", "display: none"); 
    document.getElementById("login-btn-ini").setAttribute("style","display:block");
    document.getElementById("login-panel-title").setAttribute("style", "display:block");
  }

  function constantQuery() {
      let flag = 1;
      let query = setInterval(() => {
          flag += 1;
          queryWxPusher(code).then(res => {
              if (res.code === 1000) {
                  uid = res.data;
                  let message = "您已成功登录！如果是微信手机页面登录，页面不会自动跳转，请手动退回至上一个界面";
                  pushWxMessage(uid, message);
                  hideQrCode();
                  clearInterval(query);
              }
          })
          if (flag > 18) {
              document.getElementById("qr-info").setAttribute("style", "display:none");
              document.getElementById("qr-expire").setAttribute("style", "display:block");
              clearInterval(query);
          }
      }, 10000);
  }

  function hideQrCode() {
    document.getElementById("qr-code-panel").setAttribute("style","display:none");
    document.getElementById("loader-1").setAttribute("style", "display:block");
    faunaFindItemByValue('student', 'student_uid', uid)
    .then(res => {
      if (JSON.stringify(res) !== JSON.stringify({})) {
        studentname = res.data.student_name;
        contact = res.data.contact;
        targetscore = res.data.targetscore;
        document.getElementById("loader-1").setAttribute("style","display:block");
        let linkNode = document.getElementsByTagName('link')[1];
        linkNode.disabled = true;
        loadPanel();
      } else {
        document.getElementById("loader-1").setAttribute("style", "display: none");     
        document.getElementById("login-panel").setAttribute("style","display:block");
      }
    });
  }

</script>

</head>
<body class="align">
  <div id="qr-code-panel" style="display:flex; flex-direction: column; align-items: center;">
    <div id="login-panel-title">
      欢迎使用在线约课管理系统
    </div>
    <img id="wechat-icon" width="50px" style="display:none" src="assets/wechat-icon.png">
    <button class="btn-normal" id="login-btn-ini" style="margin:20px 0;cursor: pointer;" onclick="createQrCodeHtml()">登陆</button>
    <img id="qr-code" width="250px" src="" onload="qrCodeLoaded()">
    <span id="qr-info" style="display:none;">扫码后等待5秒左右，自动跳转</span>
    <span id="qr-expire" style="display:none;">已过期，请刷新页面重新扫码</span>
  </div>

  <div class="grid" id="login-panel" style="display:none">
    <div id="login-panel-title">
      请输入您的基本信息
    </div>
    <form class="form login" id="login-form">
      <div class="form__field">
        <label for="login__studentname"><span>姓名</span></label>
        <input autocomplete="studentname" id="login__studentname" type="text" name="studentname" class="form__input" placeholder="姓名或微信昵称" maxlength="10" required>
      </div>

      <div class="form__field">
        <label for="login__contact"><span>联系方式</span></label>
        <input autocomplete="contact" id="login__contact" type="text" 
         name="contact" class="form__input" placeholder="电话号码" 
         pattern="\+?[0-9 ]*" maxlength="20" required>
      </div>

      <div class="form__field">
        <label for="login__targetscore"><span>目标分数</span></label>
        <input id="login__targetscore" type="text" name="targetscore" class="form__input" placeholder="输入目标分" maxlength="5" required>
      </div>

      <div class="form__field">
        <input type="submit" id="login-btn" value="登陆">
      </div>
    </form>
  </div>

  <div id='calendar' style="display:none"></div>
  <div class="loader loader--style1" style="display:none" id="loader-1" title="0">
    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
    width="80px" height="80px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
    <path opacity="0.2" fill="#000" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946
      s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634
      c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z"/>
    <path fill="#000" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0
      C22.32,8.481,24.301,9.057,26.013,10.047z">
      <animateTransform attributeType="xml"
        attributeName="transform"
        type="rotate"
        from="0 20 20"
        to="360 20 20"
        dur="0.5s"
        repeatCount="indefinite"/>
      </path>
    </svg>
  </div>

  <div class="grid" id="book-panel" style="display: none;">
    <div id="login-panel-title">
      选课提交信息确认
    </div>
    <div id="student-profile">
      <div>姓名：<span id="studentname"></span></div>
      <div>联系方式：<span id="contact"></span></div>
    </div>
    <ul id="course-profile"></ul>
    <form class="form login" id="submit-form">
      <div class="form__field">
        <label for="targetscore"><span>目标分数</span></label>
        <input id="targetscore" type="text" name="targetscore" placeholder="请填写目标分数" maxlength="5" required>
      </div>
      <div class="form__field">
        <label for="course-type"><span>预约类型</span></label>
        <select id="course-type" name="somename" required>
          <option value="">请选择预约类型</option>
          <option value="mock分析">mock分析</option>
          <option value="口语">口语</option>
          <option value="听力">听力</option>
          <option value="阅读">阅读</option>
          <option value="写作">写作</option>
        </select>
      </div>

      <div>
        <div class="form__field" style="float:right; width:45%;">
          <input type="submit" id="save-btn" value="提交">
        </div>
        <svg version="1.1" id="loader-2" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="40px" height="40px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
          <path opacity="0.2" fill="#1186ed" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946
            s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634
            c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z"/>
          <path fill="#1186ed" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0
            C22.32,8.481,24.301,9.057,26.013,10.047z">
          <animateTransform attributeType="xml"
            attributeName="transform"
            type="rotate"
            from="0 20 20"
            to="360 20 20"
            dur="0.5s"
            repeatCount="indefinite"/>
          </path>
        </svg>
      
        <div class="form__field" style="float:left; width:45%;">
          <input class="return" id="exit-btn" onclick="returnBack()" value="返回">
        </div>
      </div>
      <ul id="admin-messages" style="list-style-type: none; padding-left: 5px; margin: 0;"></ul>
    </form>
  </div>
</body>
</html>
