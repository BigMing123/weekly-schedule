<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<link href='lib/main.css' rel='stylesheet' />
<link href='lib/tutor-view.css' rel='stylesheet' />
<script src='lib/main.js'></script>
<script src='lib/locales/zh-cn.js'></script>
<script src="lib/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/faunadb@latest/dist/faunadb.js"></script>
<script src="lib/fauna-api.js"></script>
<script>
  let linkNode = document.getElementsByTagName('link')[1];
  linkNode.disabled = true;
  let eventsData = [];
  let hiddenDays = [];
  let calendar = null;
  let startTime = null;
  let endTime = null;
  let selectedSlots = [];
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
      locale: zhCn,
      initialDate: '2020-09-12',
      initialView: 'timeGridWeek',
      nowIndicator: true,
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'timeGridWeek'
      },
      eventClick: function(info) {
        let dbId = info.event.extendedProps.dbId;
        let start = info.event._instance.range.start;
        let end = info.event._instance.range.end;
        let title = info.event.title;
        let event = {};
        for (let i = 0; i < eventsData.length; i++) {
          if (eventsData[i].dbId === dbId) {
            if (eventsData[i].status === 'selectable') {
              selectedSlots.push(dbId);
              eventsData[i].status = 'selected';
              eventsData[i].color = '#cc8e31';
              eventsData[i].title = '已选择';
            } else if (eventsData[i].status === 'selected'){  
              selectedSlots.splice(selectedSlots.indexOf(dbId), 1);
              eventsData[i].status = 'selectable';
              eventsData[i].color = '#29b80d';
              eventsData[i].title = '';
            }
            event = eventsData[i];
          }
        }
        let newEvents = JSON.parse(JSON.stringify(eventsData));
        calendar.setOption('events', newEvents);
        calendar.render();
      },
      navLinks: true, // can click day/week names to navigate views
      editable: false,
      selectable: false,
      selectMirror: true,
      dayMaxEvents: true, // allow "more" link when too many events
      events: eventsData,
      select: function(event) {
        let start = event.start;
        let end = event.end;
        startTime = event.start;
        endTime = event.end;
      },
      selectOverlap : false,
      validRange: {
          start: new Date(new Date().setDate(new Date().getDate() - 6)),
          end: new Date(new Date().setDate(new Date().getDate() + 30))
      },
      hiddenDays: []   //设置不可选的工作日，1,3 代表周一周三 0代表周日
    });
    loadPanel(0);
    prepareSubmitForm();
  });

  function loadPanel(option) { //option 0 表示一开始加载网页，option 1 表示之后重新加载
    faunaGetEvents()
    .then(events => {
      let clsEvents = []
      for (let i = 0; i < events.length; i++) {
        let event = events[i].data;
        event.dbId = events[i].ref.id;
        event.title = "";
        if (event.status === 'taken' || new Date() > new Date(event.start)) {
          event.color = "#A9A9A9";
        } else {
          event.color = "#29b80d";
          event.status = "selectable";
        }
        clsEvents.push(event);
      }
      getAdminSetting()
      .then(ret => {
        eventsData = clsEvents;
        calendar.setOption('events', clsEvents);
        calendar.render();
        if (option === 0) {
          configPanel(calendar, ret.data.slotMinMax, ret.data.unavailableTimeSlots, ret.data.hiddenDays);
          setupSubmitBtn();
        }
        hideLoader();
      })
    })
  }

  function hideLoader() {
    let loader = document.getElementById("loader");
    loader.setAttribute("style","display: none;");
  }

  function configPanel(calendar, slotMinMax, unavailableTimeSlots, hiddenDays) {
    //设置最早最晚时间
    calendar.setOption('slotMinTime', `${slotMinMax[0]}:00:00`);
    calendar.setOption('slotMaxTime', `${slotMinMax[1]}:00:00`);
    //设置不可选时间段
    for(let i = 0; i < unavailableTimeSlots.length; i++) {
      setUnavailableTimeSlots(calendar, unavailableTimeSlots[i][0], unavailableTimeSlots[i][1]);
    }
    //设置不可选工作日
    calendar.setOption('hiddenDays', hiddenDays);
  }
  
  function setupSubmitBtn() {
    let topEle = document.getElementsByClassName("fc-header-toolbar fc-toolbar fc-toolbar-ltr")[0];
    let submitBtn = document.createElement("button");
    submitBtn.innerHTML = "提交选课";
    submitBtn.className = "fc-timeGridWeek-button fc-button fc-button-primary fc-button-active";
    topEle.appendChild(submitBtn);
    submitBtn.setAttribute("onclick", "onSubmit()");
  }

  function redirectAdmin(){
    let path = location.pathname;
    let prefix = path.substring(0,path.lastIndexOf('/'));
    window.location.href= prefix + '/tutor-view.html';
  }

  function onSubmit(){
    if (!startTime || !endTime) {
      return;
    }
    let startInputEle = document.getElementById("start-info");
    let endInputEle = document.getElementById("end-info");
    startInputEle.setAttribute("value", startTime.toLocaleString("zh-cn"));
    endInputEle.setAttribute("value", endTime.toLocaleString("zh-cn"));

    let calendar = document.getElementById("calendar");
    calendar.setAttribute("style", "display: none");

    let linkNode = document.getElementsByTagName('link')[1];
    linkNode.disabled = false;

    let bookPanel = document.getElementById("book-panel");
    bookPanel.setAttribute("style", "display: block");
  }

  function returnBack() {
    let bookPanel = document.getElementById("book-panel");
    bookPanel.setAttribute("style", "display: none");

    let linkNode = document.getElementsByTagName('link')[1];
    linkNode.disabled = true;

    loadPanel(1);
    
    let calendar = document.getElementById("calendar");
    calendar.setAttribute("style", "display: block");
  }

  function setUnavailableTimeSlots(calendar, startHour, endHour) {
    for (let i = 0; i < 30; i++) {
      let date = new Date(new Date().setDate(new Date().getDate() + i));
      let start = new Date(date.setHours(startHour,0,0,0));
      let end = new Date(date.setHours(endHour,0,0,0));
      let unselectableItem = setUnavailableTimeSlot(start, end)
      calendar.addEvent(unselectableItem);
    }
  }

  function setUnavailableTimeSlot(start, end) {
    var eventItem = {
      id: new Date().valueOf() + Math.round(Math.random() * 100),
      start: start,
      end: end,
      color: '#A9A9A9'
    };
    return eventItem;
  }

  function isValid(str){
    return !/[~`!#$%\^&*+=\-\[\]\\';,/{}|\\":<>\?]/g.test(str);
  }

  function prepareSubmitForm() {
    const form = document.getElementById('submit-form');
    form.addEventListener('submit', (event) => {
      event.preventDefault();
      let studentName = event.srcElement[2].value;
      let phoneNum = event.srcElement[3].value;
      submitBooking(studentName, phoneNum);
    });
  }

  function submitBooking(studentName, phoneNum) {
    let start = startTime;
    let end = endTime;
    let loader = document.getElementById("loader-2");
    let submitBtn = document.getElementById("save-btn");
    submitBtn.setAttribute("style", "display:none");
    loader.setAttribute("style", "display:block");
    avoidDoubleBook(start,end)
    .then(res => {
      if (res) {
        let id = new Date().valueOf() + Math.round(Math.random() * 100);
        var newEvent = {
          id: id,
          title: studentName,
          contact: phoneNum,
          start: start.toISOString(),
          end: end.toISOString()
        };
        faunaAddEvent(newEvent).then(res => {
          submitBtn.setAttribute("style", "display:block");
          loader.setAttribute("style", "display:none");
          calendar.unselect();
          returnBack();
        })
      } else {
        alert("该时间段已被占用");
        submitBtn.setAttribute("style", "display:block");
        loader.setAttribute("style", "display:none");
        returnBack();
      }
    })
  }

  async function avoidDoubleBook(start, end) {
    return new Promise(resolve => {
      faunaGetEvents()
      .then(events => {
        let flag = true;
        for (let i = 0; i < events.length; i++) {
          let event = events[i].data;
          let s = new Date(event.start);
          let e = new Date(event.end);
            if (start < e && start >= s) {
              flag = false;
            }
            if (end <= e && end > s) {
              flag = false;
            }
        }
        return resolve(flag);
      })
    })
  }

</script>




<style>
  body {
    margin: 40px 10px;
    padding: 0;
    font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
    font-size: 14px;
  }

  #calendar {
    max-width: 1100px;
    margin: 0 auto;
  }

  .loader{
    margin: 0 0 2em;
    height: 100px;
    width: 20%;
    text-align: center;
    padding: 1em;
    margin: 0 auto 1em;
    display: inline-block;
    vertical-align: top;
  }

  #loader, #loader-1 {
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
    margin: auto;
  }

  #loader-1 {
    transform:scale(1.3);
  }
  
  .fc-header-toolbar.fc-toolbar.fc-toolbar-ltr .fc-toolbar-chunk:nth-child(3) {
    display:none !important;
  }

  .grid {
    max-inline-size: 25rem;
  }

  #start-info, #end-info {
    background-color: #1186ed;
  }

  #start-info:hover, #end-info:hover {
    background-color: #1186ed;
  }

  #loader-2 {
    float: right;
    width: 50%;
    margin: 6px;
    display: none;
  }

  .fc-scrollgrid-sync-inner a.fc-col-header-cell-cushion {
    pointer-events: none;
  }

  table.fc-scrollgrid-sync-table {
    display: none;
  }

  div.fc-view-harness.fc-view-harness-active {
    height: 600px !important;
  }

  .fc-timegrid-event-harness.fc-timegrid-event-harness-inset a {
    cursor: pointer;
  }

  .fc-timegrid-slots tbody tr {
    height: 35px;
  }

  .fc-event-main-frame .fc-event-time {
    flex-grow: 4;
    text-align: center;
    font-size:14px !important;
    display:flex;
    flex-direction: column;
    justify-content: center;
  }

  .fc-event-main-frame .fc-event-title-container {
    position: absolute;
    flex-grow: 0;
  }
</style>
</head>

<body class="align">
  <div id='calendar'>
    
  </div>
  <!-- loader -->
  <div class="loader loader--style1" id="loader" title="0">
    <svg version="1.1" id="loader-1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
    width="80px" height="80px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
    <path opacity="0.2" fill="#000" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946
      s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634
      c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z"/>
    <path fill="#000" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0
      C22.32,8.481,24.301,9.057,26.013,10.047z">
      <animateTransform attributeType="xml"
        attributeName="transform"
        type="rotate"
        from="0 20 20"
        to="360 20 20"
        dur="0.5s"
        repeatCount="indefinite"/>
      </path>
    </svg>
  </div>

  <div class="grid" id="book-panel" style="display: none">
    <div id="login-panel-title">
      选课提交信息确认
    </div>
    <form class="form login" id="submit-form">
      <div class="form__field">
        <label for="start-info" style="inline-size: 200px;"><span>课程开始时间</span></label>
        <input id="start-info" type="text" name="quantity" value="20:00" placeholder="如1-2,3-4" readonly>
      </div>
      <div class="form__field">
        <label for="end-info" style="inline-size: 200px;"><span>课程结束时间</span></label>
        <input id="end-info" type="text" name="quantity" value="20:00" placeholder="如1-2,3-4" readonly>
      </div>
      <div class="form__field">
        <label for="name" style="inline-size: 200px;"><span>学员姓名</span></label>
        <input id="name" type="text" name="quantity" placeholder="请输入姓名" maxlength="10" required>
      </div>

      <div class="form__field">
        <label for="phone" style="inline-size: 200px;"><span>手机号</span></label>
        <input id="phone" type="text" name="quantity" placeholder="请填写手机号" maxlength="20" required>
      </div>

      <div>
        <div class="form__field" style="float:right; width:45%;">
          <input type="submit" id="save-btn" value="提交">
        </div>
        <!-- loader2 -->
        <svg version="1.1" id="loader-2" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
            width="40px" height="40px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
            <path opacity="0.2" fill="#1186ed" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946
              s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634
              c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z"/>
            <path fill="#1186ed" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0
              C22.32,8.481,24.301,9.057,26.013,10.047z">
              <animateTransform attributeType="xml"
                attributeName="transform"
                type="rotate"
                from="0 20 20"
                to="360 20 20"
                dur="0.5s"
                repeatCount="indefinite"/>
              </path>
            </svg>
      
        <div class="form__field" style="float:left; width:45%;">
          <input class="return" id="exit-btn" onclick="returnBack()" value="返回">
        </div>
      </div>
      <ul id="admin-messages" style="list-style-type: none; padding-left: 5px; margin: 0;"></ul>
    </form>
  </div>

</body>
</html>
