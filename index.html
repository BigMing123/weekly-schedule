<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<link href='lib/main.css' rel='stylesheet' />
<link href='lib/common.css' rel='stylesheet' />
<link href='lib/student-interface.css' rel='stylesheet' />
<script src='lib/main.js'></script>
<script src='lib/locales/zh-cn.js'></script>
<script src="lib/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/faunadb@latest/dist/faunadb.js"></script>
<script src="lib/fauna-api.js"></script>
<script src="lib/wxpusher-api.js"></script>
<script>
  let eventsData = [];
  let hiddenDays = [];
  let calendar = null;
  let selectedSlots = [];
  let code = "";
  let uid = "";
  let studentname = "";
  let contact = "";
  let targetscore = "";
  const maxCourseCount = 5; //最多一次选课多少节
  const monthStart = new Date(new Date().setMonth(new Date().getMonth()));
  const monthEnd = new Date(new Date().setMonth(new Date().getMonth() + 1));
  const monthEndOneDayExtra = new Date(monthEnd.getTime() + 86400000); //结尾多一天
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
      locale: zhCn,
      initialDate: '2020-09-12',
      initialView: 'timeGridWeek',
      nowIndicator: true,
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'timeGridWeek'
      },
      eventClick: function(info) {
        let dbId = info.event.extendedProps.dbId;
        let start = info.event._instance.range.start;
        let end = info.event._instance.range.end;
        let title = info.event.title;
        let event = {};
        for (let i = 0; i < eventsData.length; i++) {
          if (eventsData[i].dbId === dbId) {
            if (eventsData[i].status === 'selectable') {
              if (selectedSlots.length > maxCourseCount - 1) {
                return;
              }
              selectedSlots.push(dbId);
              eventsData[i].status = 'selected';
              eventsData[i].color = '#cc8e31';
              eventsData[i].title = '已选择';
            } else if (eventsData[i].status === 'selected'){  
              selectedSlots.splice(selectedSlots.indexOf(dbId), 1);
              eventsData[i].status = 'selectable';
              eventsData[i].color = '#29b80d';
              eventsData[i].title = '';
            }
            event = eventsData[i];
          }
        }
        let newEvents = JSON.parse(JSON.stringify(eventsData));
        calendar.setOption('events', newEvents);
        calendar.render();
      },
      navLinks: true, // can click day/week names to navigate views
      editable: false,
      selectable: false,
      selectMirror: true,
      dayMaxEvents: true, // allow "more" link when too many events
      events: eventsData,
      select: function(event) {
        let start = event.start;
        let end = event.end;
        startTime = event.start;
        endTime = event.end;
      },
      selectOverlap : false,
      validRange: {
          // start: new Date(new Date().setDate(new Date().getDate() - 6)),
          // end: new Date(new Date().setDate(new Date().getDate() + 30))
          start: monthStart,
          end: monthEnd
      },
      hiddenDays: [],   //设置不可选的工作日，1,3 代表周一周三 0代表周日
      slotMinTime: '07:00:00',
      slotMaxTime: '22:00:00'
    });
    prepareLoginForm();
    // document.getElementById("qr-code-panel").setAttribute("style","display:none");
    // showLoader();
    // loadPanel();
  });

  function loadPanel() {
    let linkNode = document.getElementsByTagName('link')[1];
    linkNode.disabled = true;
    document.getElementById("login-panel").setAttribute("style", "display:none");
    loadAdminEvents(0);
    prepareSubmitForm();
  }

  function hideLoader() {
    let loader = document.getElementById("loader-1");
    loader.setAttribute("style","display: none;");
    let calendarEle = document.getElementById("calendar");
    calendarEle.setAttribute("style", "display: block");
  }

  function showLoader() {
    let loader = document.getElementById("loader-1");
    loader.setAttribute("style","display: block;");
    let calendar = document.getElementById("calendar");
    calendar.setAttribute("style", "display: none");
  }

  function setupSubmitBtn() {
    let topEle = document.getElementsByClassName("fc-header-toolbar fc-toolbar fc-toolbar-ltr")[0];
    let submitBtn = document.createElement("button");
    submitBtn.innerHTML = "提交选课";
    submitBtn.className = "fc-timeGridWeek-button fc-button fc-button-primary fc-button-active";
    topEle.appendChild(submitBtn);
    submitBtn.setAttribute("onclick", "onSubmit()");
  }

  function onSubmit(){
    let startInputEle = document.getElementById("start-info");
    let endInputEle = document.getElementById("end-info");
    startInputEle.setAttribute("value", new Date().toLocaleString("zh-cn"));
    endInputEle.setAttribute("value", new Date().toLocaleString("zh-cn"));

    let calendar = document.getElementById("calendar");
    calendar.setAttribute("style", "display: none");

    let linkNode = document.getElementsByTagName('link')[1];
    linkNode.disabled = false;

    let bookPanel = document.getElementById("book-panel");
    bookPanel.setAttribute("style", "display: block");
  }

  function prepareLoginForm() {
    const form = document.getElementById('login-form');
    form.addEventListener('submit', (event) => {
      event.preventDefault();
      studentname = event.srcElement[0].value;
      contact = event.srcElement[1].value;
      targetscore = event.srcElement[2].value;
      login();
    });
  }

  function login() {
    let student = {student_uid: uid, student_name: studentname, contact: contact, targetscore: targetscore};
    faunaAddStudent(student)
    .then(res => {
      if (JSON.stringify(res) !== JSON.stringify({})) {
        showLoader();
        loadPanel();
      }
    })


    faunaFindItemByValue('user', 'username', username)
    .then((res) => {
      if (Object.keys(res).length != 0) {
        let pw = res.data.password;
        let linkNode = document.getElementsByTagName('link')[1];
        linkNode.disabled = true;
        prepareUserProfile(tutorname);
        loadPanel();
      } else {
        appendAlertInfo("登陆失败，用户名密码不正确");
        loginPanel.setAttribute("style","display:block");
        loader.setAttribute("style","display:none");
      }
    });
  }

  function returnBack() {
    let bookPanel = document.getElementById("book-panel");
    bookPanel.setAttribute("style", "display: none");

    let linkNode = document.getElementsByTagName('link')[1];
    linkNode.disabled = true;

    showLoader();
    loadAdminEvents(1);
  }

  function isValid(str){
    return !/[~`!#$%\^&*+=\-\[\]\\';,/{}|\\":<>\?]/g.test(str);
  }

  function prepareSubmitForm() {
    const form = document.getElementById('submit-form');
    form.addEventListener('submit', (event) => {
      event.preventDefault();
      console.log(111)
      let studentName = event.srcElement[2].value;
      let phoneNum = event.srcElement[3].value;
      submitBooking(studentName, phoneNum);
    });
  }

  function submitBooking(studentName, phoneNum) {
    let start = startTime;
    let end = endTime;
    let loader = document.getElementById("loader-2");
    let submitBtn = document.getElementById("save-btn");
    submitBtn.setAttribute("style", "display:none");
    loader.setAttribute("style", "display:block");
    avoidDoubleBook(start,end)
    .then(res => {
      if (res) {
        let id = new Date().valueOf() + Math.round(Math.random() * 100);
        var newEvent = {
          id: id,
          title: studentName,
          contact: phoneNum,
          start: start.toISOString(),
          end: end.toISOString()
        };
        faunaAddEvent(newEvent).then(res => {
          submitBtn.setAttribute("style", "display:block");
          loader.setAttribute("style", "display:none");
          calendar.unselect();
          returnBack();
        })
      } else {
        alert("该时间段已被占用");
        submitBtn.setAttribute("style", "display:block");
        loader.setAttribute("style", "display:none");
        returnBack();
      }
    })
  }

  function loadAdminEvents(option) {
    let clsEvents = []
    let startISOstr = new Date(monthStart.getTime());
    startISOstr.setHours(0);
    startISOstr.setMinutes(0);
    startISOstr.setSeconds(0);
    startISOstr = startISOstr.toISOString();
    let endISOstr = new Date(monthEndOneDayExtra.getTime());
    endISOstr.setHours(0);
    endISOstr.setMinutes(0);
    endISOstr.setSeconds(0);
    endISOstr = endISOstr.toISOString();
    faunaGetEventsCurrentMonth(startISOstr, endISOstr)
    .then(events => {

      events.map(event => {
        let newEvent = event.data;
        newEvent.start = newEvent.start.value;
        newEvent.end = newEvent.end.value;
        newEvent.color = "#29b80d";
        newEvent.status = "selectable";
        newEvent.dbId = event.ref.id;
        clsEvents.push(newEvent);
      })

      eventsData = clsEvents;
      hideLoader();
      calendar.setOption('events', clsEvents);
      calendar.render();
      if (option === 0) {
        setupSubmitBtn();
      }
    })
  }

  function createQrCodeHtml() {
    document.getElementById("loader-1").setAttribute("style", "display: block"); 
    document.getElementById('login-btn-ini').setAttribute("style", "display: none");
    document.getElementById("login-panel-title").setAttribute("style", "display:none");
    createQrCode()
    .then(res => {
      document.getElementById("qr-code").setAttribute("src",res.url);
      code = res.code;
      constantQuery();
    })
    .catch(err => {
      qrCodeNotLoaded();
    })
  }

  function qrCodeLoaded() {
    document.getElementById("loader-1").setAttribute("style", "display: none"); 
    document.getElementById("qr-info").setAttribute("style", "display:block");
    document.getElementById("login-panel-title").setAttribute("style", "display:block;margin-bottom:-30px");
    document.getElementById("wechat-icon").setAttribute("style","display:block; position:relative; top:150px;");
    document.getElementById("login-btn-ini").setAttribute("style","display:none");
  }

  function qrCodeNotLoaded() {
    document.getElementById("loader-1").setAttribute("style", "display: none"); 
    document.getElementById("login-btn-ini").setAttribute("style","display:block");
    document.getElementById("login-panel-title").setAttribute("style", "display:block");
  }

  function constantQuery() {
      let flag = 1;
      let query = setInterval(() => {
          flag += 1;
          queryWxPusher(code).then(res => {
              if (res.code === 1000) {
                  uid = res.data;
                  hideQrCode();
                  clearInterval(query);
              }
          })
          if (flag > 18) {
              document.getElementById("qr-info").setAttribute("style", "display:none");
              document.getElementById("qr-expire").setAttribute("style", "display:block");
              clearInterval(query);
          }
      }, 10000);
  }

  function hideQrCode() {
    document.getElementById("qr-code-panel").setAttribute("style","display:none");
    document.getElementById("loader-1").setAttribute("style", "display:block");
    faunaFindItemByValue('student', 'student_uid', uid)
    .then(res => {
      if (JSON.stringify(res) !== JSON.stringify({})) {
        student_name = res.data.student_name;
        contact = res.data.contact;
        targetscore = res.data.targetscore;
        document.getElementById("loader-1").setAttribute("style","display:block");
        let linkNode = document.getElementsByTagName('link')[1];
        linkNode.disabled = true;
        loadPanel();
      } else {
        document.getElementById("loader-1").setAttribute("style", "display: none");     
        document.getElementById("login-panel").setAttribute("style","display:block");
      }
    });
  }

</script>

</head>
<body class="align">
  <div id="qr-code-panel" style="display:flex; flex-direction: column; align-items: center;">
    <div id="login-panel-title">
      欢迎使用在线约课管理系统
    </div>
    <img id="wechat-icon" width="50px" style="display:none" src="assets/wechat-icon.png">
    <button class="btn-normal" id="login-btn-ini" style="margin:20px 0;cursor: pointer;" onclick="createQrCodeHtml()">扫码登陆</button>
    <img id="qr-code" width="250px" src="" onload="qrCodeLoaded()">
    <span id="qr-info" style="display:none;">扫码后等待5秒左右，自动跳转</span>
    <span id="qr-expire" style="display:none;">已过期，请刷新页面重新扫码</span>
  </div>

  <div class="grid" id="login-panel" style="display:none">
    <div id="login-panel-title">
      请输入您的基本信息
    </div>
    <form class="form login" id="login-form">
      <div class="form__field">
        <label for="login__studentname"><span>姓名</span></label>
        <input autocomplete="studentname" id="login__studentname" type="text" name="studentname" class="form__input" placeholder="姓名或微信昵称" maxlength="10" required>
      </div>

      <div class="form__field">
        <label for="login__contact"><span>联系方式</span></label>
        <input autocomplete="contact" id="login__contact" type="text" 
         name="contact" class="form__input" placeholder="电话号码" 
         pattern="\+?[0-9 ]*" maxlength="20" required>
      </div>

      <div class="form__field">
        <label for="login__targetscore"><span>目标分数</span></label>
        <input id="login__targetscore" type="text" name="targetscore" class="form__input" placeholder="输入目标分" maxlength="5" required>
      </div>

      <div class="form__field">
        <input type="submit" id="login-btn" value="登陆">
      </div>
    </form>
  </div>

  <div id='calendar' style="display:none"></div>
  <div class="loader loader--style1" style="display:none" id="loader-1" title="0">
    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
    width="80px" height="80px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
    <path opacity="0.2" fill="#000" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946
      s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634
      c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z"/>
    <path fill="#000" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0
      C22.32,8.481,24.301,9.057,26.013,10.047z">
      <animateTransform attributeType="xml"
        attributeName="transform"
        type="rotate"
        from="0 20 20"
        to="360 20 20"
        dur="0.5s"
        repeatCount="indefinite"/>
      </path>
    </svg>
  </div>

  <div class="grid" id="book-panel" style="display: none">
    <div id="login-panel-title">
      选课提交信息确认
    </div>
    <form class="form login" id="submit-form">
      <div class="form__field">
        <label for="start-info" style="inline-size: 200px;"><span>课程开始时间</span></label>
        <input id="start-info" type="text" name="quantity" value="20:00" placeholder="如1-2,3-4" readonly>
      </div>
      <div class="form__field">
        <label for="end-info" style="inline-size: 200px;"><span>课程结束时间</span></label>
        <input id="end-info" type="text" name="quantity" value="20:00" placeholder="如1-2,3-4" readonly>
      </div>
      <div class="form__field">
        <label for="name" style="inline-size: 200px;"><span>学员姓名</span></label>
        <input id="name" type="text" name="quantity" placeholder="请输入姓名" maxlength="10" required>
      </div>

      <div class="form__field">
        <label for="phone" style="inline-size: 200px;"><span>手机号</span></label>
        <input id="phone" type="text" name="quantity" placeholder="请填写手机号" maxlength="20" required>
      </div>

      <div>
        <div class="form__field" style="float:right; width:45%;">
          <input type="submit" id="save-btn" value="提交">
        </div>
        <svg version="1.1" id="loader-2" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="40px" height="40px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
          <path opacity="0.2" fill="#1186ed" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946
            s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634
            c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z"/>
          <path fill="#1186ed" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0
            C22.32,8.481,24.301,9.057,26.013,10.047z">
          <animateTransform attributeType="xml"
            attributeName="transform"
            type="rotate"
            from="0 20 20"
            to="360 20 20"
            dur="0.5s"
            repeatCount="indefinite"/>
          </path>
        </svg>
      
        <div class="form__field" style="float:left; width:45%;">
          <input class="return" id="exit-btn" onclick="returnBack()" value="返回">
        </div>
      </div>
      <ul id="admin-messages" style="list-style-type: none; padding-left: 5px; margin: 0;"></ul>
    </form>
  </div>
</body>
</html>
