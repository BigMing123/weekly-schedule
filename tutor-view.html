<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<link href='lib/main.css' rel='stylesheet' />
<link href='lib/common.css' rel='stylesheet' />
<link href='lib/tutor-interface.css' rel='stylesheet' />
<script src='lib/main.js'></script>
<script src='lib/locales/zh-cn.js'></script>
<script src="lib/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/faunadb@latest/dist/faunadb.js"></script>
<script src="lib/fauna-api.js"></script>
<script src="lib/wxpusher-api.js"></script>

<script>
  let code = "";
  let uid = 'UID_U6cNrnSNU6jWHgwxw9Z4YXJoOaO1'; //测试
  // let uid = '';
  let tutor_name = "";
  let bookedEventsData = [];
  let adminEventsData = [];
  let slotMinMax = [8,23];
  let hiddenDays = [];
  let calendar = null;
  let calendar2 = null;
  let saveBtnAdded = false;
  let adminEvents = [];
  let configCurrentDay = null;
  let copyEvents = [];
  let startISOstr = null;
  let endISOstr = null;
  const monthStart = new Date(new Date().setMonth(new Date().getMonth()));
  const monthEnd = new Date(new Date().setMonth(new Date().getMonth() + 1));
  const monthEndOneDayExtra = new Date(monthEnd.getTime() + 86400000); //结尾多一天
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
      headerToolbar: {
        left: 'prevYear,prev,next,nextYear today',
        center: 'title',
        // right: 'timeGridWeek'
        right: 'dayGridMonth'
      },
      locale: zhCn,
      displayEventEnd: true,
      initialDate: new Date(),
      initialView: 'dayGridMonth',
      navLinks: true, // can click day/week names to navigate views
      editable: true,
      dayMaxEvents: false, // allow "more" link when too many events
      // slotMinTime: '07:00:00',
      // slotMaxTime: '22:00:00',
      eventContent: modifiedEventContent,
      events: bookedEventsData,
      editable: false,
      eventClick: function(info) {
        let dbId = info.event.extendedProps.dbId;
        let start = info.event._instance.range.start;
        let end = info.event._instance.range.end;
        let title = info.event.title;
        confirmDeleting = confirm(`删除： ${start.toLocaleString("zh-cn")}` + 
                                  ` - ${end.toLocaleString("zh-cn")}` +
                                  `\n${title}        是否删除该项目？`);
        if (confirmDeleting) {
          faunaDeleteEvent(dbId)
          .then(res => {
            loadPanel();
          });
        }
      }
    });

    var calendarEl2 = document.getElementById('calendar2');
    calendar2 = new FullCalendar.Calendar(calendarEl2, {
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth'
      },
      locale: zhCn,
      initialDate: new Date(),
      displayEventEnd: true,
      navLinks: true, // can click day/week names to navigate views
      editable: true,
      // dayMaxEvents: true, // allow "more" link when too many events
      events: adminEventsData,
      editable: false,
      eventClick: function(info) {
        let start = info.event._instance.range.start;
        let end = info.event._instance.range.end;
      },
      validRange: {
        start: monthStart,
          end: monthEnd
      },
      selectable: true,
      select: function(info) {
        configCurrentDay = info.start;
        if (copyEvents.length !== 0) {
          finishCopyDay();
        } else {
          showConfigDayWindow(1);
        }
      },
      selectLongPressDelay: 1
    });
    prepareISOstr();
    prepareLoginForm();
    prepareAddDayEvent();
    hideQrCode(); //测试
    // modifyEventContent(); //测试
  });

  function modifiedEventContent(arg) {
    let event = arg.event;
    let start = new Date(event.start.getTime());
    let end = new Date(event.end.getTime());
    let startTime = start.getHours() + ':' + (start.getMinutes()<10?'0':'') + start.getMinutes();
    let endTime = end.getHours() + ':' + (end.getMinutes()<10?'0':'') + end.getMinutes();
    let timeSpan = startTime + "-" + endTime;
    let courseType = event.extendedProps.course_type;
    let name = event.extendedProps.student_name;
    console.log(event)
    return {
      html: 
      `<ul class="custom-event-single">  \
          <li class="course-type">${courseType}</li>    \
          <li class="name">${name}</li>  \
          <li class="time-span">${timeSpan}</li>   
      </ul>`
    }
  }

  function avoidDouble(start, end) {
    let flag = true;
    for (let i = 0; i < adminEvents.length; i++) {
      let event = adminEvents[i];
      let s = new Date(event.start);
      let e = new Date(event.end);
        if (start < e && start >= s) {
          flag = false;
        }
        if (end <= e && end > s) {
          flag = false;
        }
    }
    return flag;
  }

  function prepareAddDayEvent() {
    let addDayEle = document.getElementById('config-day');
    addDayEle.addEventListener("submit", (event) => {
      event.preventDefault();
      let s = event.srcElement[1].value;
      let e = event.srcElement[4].value;
      addDay(s, e);
    });
  }

  function addDay(s, e) {
    let startTime = document.getElementById('s-time').value;
    let endTime = document.getElementById('e-time').value;
    addAdminEvent(configCurrentDay, s, e);
    showConfigDayWindow(0);
  }

  function resetDay() {
    adminEvents = adminEvents.filter(event => {
      if(new Date(event.start).toDateString() === configCurrentDay.toDateString()) {
        calendar2.getEventById(event.id).remove();
      } else {
        return true;
      }
    });
    showConfigDayWindow(0);
  }

  function copyDay() {
    copyEvents = adminEvents.filter(event => {
      if(new Date(event.start).toDateString() === configCurrentDay.toDateString())
        return true;
    });
    showConfigDayWindow(0);
    if (copyEvents.length !== 0) {
      var element = document.getElementById("calendar2");
      element.classList.add("active");
    }
  }

  function finishCopyDay() {
    resetDay(); 
    copyEvents = copyEvents.map(event => {
      let newEvent = JSON.parse(JSON.stringify(event));
      let start = new Date(newEvent.start);
      let end = new Date(newEvent.end);
      let startHours = start.getHours();
      let startMinutes = start.getMinutes();     
      let startSeconds = start.getSeconds();
      let endHours = end.getHours();
      let endMinutes = end.getMinutes();   
      let endSeconds = end.getSeconds();

      let newStart = new Date(configCurrentDay.getTime());
      let newEnd = new Date(configCurrentDay.getTime());
      newStart.setHours(startHours);
      newStart.setMinutes(startMinutes);
      newStart.setSeconds(startSeconds);
      newEnd.setHours(endHours);
      newEnd.setMinutes(endMinutes);
      newEnd.setSeconds(endSeconds);
      newEvent.start = newStart.toISOString();
      newEvent.end = newEnd.toISOString();
      newEvent.id = new Date().valueOf() + Math.round(Math.random() * 100);
      calendar2.addEvent(newEvent);
      calendar2.render();
      return newEvent;
    })
    adminEvents =  adminEvents.concat(copyEvents);
    copyEvents = [];
    var element = document.getElementById("calendar2");
    element.classList.remove("active");
  }

  function showConfigDayWindow(option) {
    if (option === 1) {
      let calendar2Ele = document.getElementById('calendar2');
      calendar2Ele.setAttribute("style","opacity:20%;pointer-events:none;");
      let configDay = document.getElementById("config-day");
      configDay.setAttribute("style","display:flex");
    } else if (option === 0) {
      let calendar2Ele = document.getElementById('calendar2');
      calendar2Ele.setAttribute("style","opacity:100%;pointer-events:auto;");
      let configDay = document.getElementById("config-day");
      configDay.setAttribute("style","display:none");
    }
  }

  function prepareISOstr() {
    startISOstr = new Date(monthStart.getTime());
    startISOstr.setHours(0);
    startISOstr.setMinutes(0);
    startISOstr.setSeconds(0);
    startISOstr = startISOstr.toISOString();
    endISOstr = new Date(monthEndOneDayExtra.getTime());
    endISOstr.setHours(0);
    endISOstr.setMinutes(0);
    endISOstr.setSeconds(0);
    endISOstr = endISOstr.toISOString();
  }

  function loadPanel() {
    let loader = document.getElementById("loader");
    loader.setAttribute("style","display:block");
    faunaGetBookedEventsCurrentMonth(startISOstr, endISOstr)
    .then(events => {
      let clsEvents = []
      for (let i = 0; i < events.length; i++) {
        let event = events[i].data;
        event['dbId'] = events[i].ref.value.id;
        let eventContact = event.contact;
        if (eventContact) {
          event.title = event.title + " " + eventContact;
        }
        event['start'] = event.start.value;
        event['end'] = event.end.value;
        clsEvents.push(event);
      }
      bookedEventsData = JSON.parse(JSON.stringify(clsEvents))
      calendar.setOption('events', bookedEventsData);
      let calendarEl = document.getElementById('summary-panel');
      calendarEl.setAttribute("style","display:block");
      calendar.render();
      let loader = document.getElementById("loader");
      loader.setAttribute("style","display:none");
    });
  }

  function adminPanel() {
    let linkNode = document.getElementsByTagName('link')[1];
    linkNode.disabled = false;
    let loader = document.getElementById("loader");
    loader.setAttribute("style", "display:block");
    loadAdminEvents();
    let summary = document.getElementById("summary-panel");
    summary.setAttribute("style","display:none");
  }

  function addAdminEvent(date, start, end) {
    let id = new Date().valueOf() + Math.round(Math.random() * 100);
    let hrMinStart = start.split(":");
    let hrMinEnd = end.split(":");
    let startTime = new Date(date);
    let endTime = new Date(date);
    startTime.setHours(hrMinStart[0]);
    startTime.setMinutes(hrMinStart[1]);
    startTime.setSeconds("0");
    endTime.setHours(hrMinEnd[0]);
    endTime.setMinutes(hrMinEnd[1]);
    endTime.setSeconds("0");

    if (endTime - startTime >= 3600 * 1000 && avoidDouble(startTime, endTime)) {
      if ((endTime - startTime) / 1000 % 3600 === 0) {
        let hours = (endTime - startTime) / 1000 / 3600;
        let s = new Date(startTime.getTime());
        let e = new Date(startTime.getTime());
        for (let i = 0; i < hours; i++) {
          e.setMinutes(e.getMinutes() + 60);
          let event = {
            "id": id,
            "title": "",
            "contact": "",
            "start": s.toISOString(),
            "end": e.toISOString()
          };
          s.setHours(s.getHours() + 1);
          // s.setMinutes(e.getMinutes() + 1);    //额外加1分钟
          e = new Date(s.getTime());
          adminEvents.push(event);
          calendar2.addEvent(event);
        }
      }
    }
    calendar2.render();
  }

  function saveConfig() {
    if (copyEvents.length !== 0)
      return;
  }

  function redirectVisitor() {
    let path = location.pathname;
    let prefix = path.substring(0,path.lastIndexOf('/'));
    window.location.href= prefix + '/index.html';
  }

  function prepareLoginForm() {
    const form = document.getElementById('login-form');
    form.addEventListener('submit', (event) => {
      event.preventDefault();
      let tutorname = event.srcElement[0].value;
      let username = event.srcElement[1].value;
      let password = event.srcElement[2].value;
      login(tutorname, username, password);
    });
  }

  function login(tutorname, username, password) {
    let loginPanel = document.getElementById("login-panel");
    let loader = document.getElementById("loader");
    // let calendarEl = document.getElementById("calendar");
    loginPanel.setAttribute("style","display:none");
    loader.setAttribute("style","display:block");
    faunaFindItemByValue('user', 'username', username)
    .then((res) => {
      if (Object.keys(res).length != 0) {
        let pw = res.data.password;
        if (password == pw) {
          let linkNode = document.getElementsByTagName('link')[1];
          linkNode.disabled = true;
          prepareUserProfile(tutorname);
          loadPanel();
        } else {
          appendAlertInfo("登陆失败，用户名密码不正确")
          loginPanel.setAttribute("style","display:block");
          loader.setAttribute("style","display:none");
        }
      } else {
        appendAlertInfo("登陆失败，用户名密码不正确");
        loginPanel.setAttribute("style","display:block");
        loader.setAttribute("style","display:none");
      }
    });
  }

  function returnBack() {
    if (copyEvents.length !== 0)
      return;
    calendar2.removeAllEvents();
    let adminPanel = document.getElementById("admin-panel");
    adminPanel.setAttribute("style", "display:none");
    let linkNode = document.getElementsByTagName('link')[1];
    linkNode.disabled = true;
    loadPanel();
  }

  function appendSuccessInfo() {
    let element = document.getElementById("admin-messages");
    let listItem = document.createElement("li");
    listItem.innerHTML = "管理数据保存成功!";
    listItem.setAttribute("style", "color:lightgreen !important");
    element.appendChild(listItem);
    setTimeout(() => {
      element.removeChild(listItem);
    }, 3000);
  }

  function appendAlertInfo(message) {
    let element = document.getElementById("admin-messages");
    let listItem = document.createElement("li");
    listItem.innerHTML = message;
    listItem.setAttribute("style", "color:#c42525 !important");
    element.appendChild(listItem);
    setTimeout(() => {
      element.removeChild(listItem);
    }, 3000);
  }

  function createQrCodeHtml() {
    document.getElementById("loader").setAttribute("style", "display: block"); 
    document.getElementById('login-btn-ini').setAttribute("style", "display: none");
    document.getElementById("login-panel-title").setAttribute("style", "display:none");
    createQrCode()
    .then(res => {
      document.getElementById("qr-code").setAttribute("src",res.url);
      code = res.code;
      constantQuery();
    })
    .catch(err => {
      qrCodeNotLoaded();
    })
  }

  function qrCodeLoaded() {
    document.getElementById("loader").setAttribute("style", "display: none"); 
    document.getElementById("qr-info").setAttribute("style", "display:block");
    document.getElementById("login-panel-title").setAttribute("style", "display:block;margin-bottom:-30px");
    document.getElementById("wechat-icon").setAttribute("style","display:block; position:relative; top:150px;");
    document.getElementById("login-btn-ini").setAttribute("style","display:none");
  }

  function qrCodeNotLoaded() {
    document.getElementById("loader").setAttribute("style", "display: none"); 
    document.getElementById("login-btn-ini").setAttribute("style","display:block");
    document.getElementById("login-panel-title").setAttribute("style", "display:block");
  }

  function constantQuery() {
      let flag = 1;
      let query = setInterval(() => {
          flag += 1;
          queryWxPusher(code).then(res => {
              if (res.code === 1000) {
                  uid = res.data;
                  hideQrCode();
                  clearInterval(query);
              }
          })
          if (flag > 18) {
              document.getElementById("qr-expire").setAttribute("style", "display:block");
              document.getElementById("qr-info").setAttribute("style", "display:none");
              clearInterval(query);
          }
      }, 10000);
  }

  function hideQrCode() {
    document.getElementById("qr-code-panel").setAttribute("style","display:none");
    faunaFindItemByValue('tutor', 'uid', uid)
    .then(res => {
      if (JSON.stringify(res) !== JSON.stringify({})) {
        tutor_name = res.data.tutor_name;
        document.getElementById("loader").setAttribute("style","display:block");
        let linkNode = document.getElementsByTagName('link')[1];
        linkNode.disabled = true;
        loadPanel();
      } else {
        document.getElementById("login-panel").setAttribute("style","display:block");
      }
    });
  }

  function prepareUserProfile(name) {
    let tutor = {tutor_name: name, uid: uid};
    faunaAddTutor(tutor);
  }

  function setupSaveBtn() {
    let parent = document.getElementById("calendar2");
    let topEle = parent.querySelector('.fc-header-toolbar.fc-toolbar.fc-toolbar-ltr');
    let submitBtn = document.createElement("button");
    submitBtn.innerHTML = "保存";
    submitBtn.className = "fc-timeGridWeek-button fc-button fc-button-primary fc-button-active";
    submitBtn.id = "admin-save-btn";
    topEle.appendChild(submitBtn);
    submitBtn.setAttribute("onclick", "adminSave()");
    saveBtnAdded = true;
  }

  function adminSave() {
    let adminSaveBtn = document.getElementById("admin-save-btn");
    adminSaveBtn.disabled = true;
    faunaAddEvents(JSON.parse(JSON.stringify(adminEvents)), 
                   adminMonthStart.toISOString(), 
                   adminMonthEnd.toISOString())
    .then(res => {
      adminSaveBtn.disabled = false;
      appendSuccessInfo();
    })
    .catch(err => {
      appendAlertInfo("数据保存失败");
    })
  }

  function hideLoaderShowAdmin() {
    let loader = document.getElementById("loader");
    loader.setAttribute("style", "display:none");
    let adminPanel = document.getElementById("admin-panel");
    adminPanel.setAttribute("style", "display:block");
  }

  function loadAdminEvents() {
    adminEvents = [];
    faunaGetEventsCurrentMonth(startISOstr, endISOstr)
    .then(events => {
      hideLoaderShowAdmin();
      events.map(event => {
        let newEvent = event.data;
        newEvent.start = newEvent.start.value;
        newEvent.end = newEvent.end.value;
        adminEvents.push(newEvent);
      })

      calendar2.setOption('events', adminEvents);
      calendar2.render();
      if (!saveBtnAdded) 
        setupSaveBtn();
    })
  }
</script>
</head>

<body class="align">
  <div id="summary-panel" style="display:none">
    <div id='calendar'>
      <button onclick='adminPanel()' class="fc-button fc-button-primary fc-button-active">进入课时管理界面</button>
    </div>
  </div>
  <div id="qr-code-panel" style="display:flex; flex-direction: column; align-items: center;">
    <div id="login-panel-title">
      欢迎使用在线约课管理系统
    </div>
    <img id="wechat-icon" width="50px" style="display:none" src="assets/wechat-icon.png">
    <button class="btn-normal" id="login-btn-ini" style="margin:20px 0;cursor: pointer;" onclick="createQrCodeHtml()">登陆</button>
    <img id="qr-code" width="250px" src="" onload="qrCodeLoaded()">
    <span id="qr-info" style="display:none;">扫码后等待5秒左右，自动跳转</span>
    <span id="qr-expire" style="display:none;">已过期，请刷新页面重新扫码</span>
  </div>

  <div class="grid" id="login-panel" style="display:none">
    <div id="login-panel-title">
      请输入您的姓名, 管理员用户名，密码
    </div>
    <form class="form login" id="login-form">
      <div class="form__field">
        <label for="login__tutorname"><svg class="icon">
            <use xlink:href="#icon-user"></use>
          </svg><span class="hidden">姓名</span></label>
        <input autocomplete="tutorname" id="login__tutorname" type="text" name="tutorname" class="form__input" placeholder="姓名" required>
      </div>

      <div class="form__field">
        <label for="login__username"><svg class="icon">
            <use xlink:href="#icon-user"></use>
          </svg><span class="hidden">用户名</span></label>
        <input autocomplete="username" id="login__username" type="text" name="username" class="form__input" placeholder="用户名" required>
      </div>

      <div class="form__field">
        <label for="login__password"><svg class="icon">
            <use xlink:href="#icon-lock"></use>
          </svg><span class="hidden">密码</span></label>
        <input id="login__password" type="password" name="password" class="form__input" placeholder="密码" required>
      </div>

      <div class="form__field">
        <input type="submit" id="login-btn" value="登陆">
      </div>
    </form>
    <!-- <p class="text--center">还不是成员? <a href="#">点此注册</a> <svg class="icon">
        <use xlink:href="#icon-arrow-right"></use>
      </svg></p> -->
  </div>

  <div class="loader loader--style1" id="loader" style="display:none" title="0">
    <svg version="1.1" id="loader-1" x="0px" y="0px"
    width="80px" height="80px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
      <path opacity="0.2" fill="#000" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946
        s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634
        c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z"/>
      <path fill="#000" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0
        C22.32,8.481,24.301,9.057,26.013,10.047z">
        <animateTransform attributeType="xml"
          attributeName="transform"
          type="rotate"
          from="0 20 20"
          to="360 20 20"
          dur="0.5s"
          repeatCount="indefinite"/>
        </path>
    </svg>
  </div>

  <svg class="icons" style="display:none">
    <symbol id="icon-arrow-right" viewBox="0 0 1792 1792">
      <path d="M1600 960q0 54-37 91l-651 651q-39 37-91 37-51 0-90-37l-75-75q-38-38-38-91t38-91l293-293H245q-52 0-84.5-37.5T128 1024V896q0-53 32.5-90.5T245 768h704L656 474q-38-36-38-90t38-90l75-75q38-38 90-38 53 0 91 38l651 651q37 35 37 90z" />
    </symbol>
    <symbol id="icon-lock" viewBox="0 0 1792 1792">
      <path d="M640 768h512V576q0-106-75-181t-181-75-181 75-75 181v192zm832 96v576q0 40-28 68t-68 28H416q-40 0-68-28t-28-68V864q0-40 28-68t68-28h32V576q0-184 132-316t316-132 316 132 132 316v192h32q40 0 68 28t28 68z" />
    </symbol>
    <symbol id="icon-user" viewBox="0 0 1792 1792">
      <path d="M1600 1405q0 120-73 189.5t-194 69.5H459q-121 0-194-69.5T192 1405q0-53 3.5-103.5t14-109T236 1084t43-97.5 62-81 85.5-53.5T538 832q9 0 42 21.5t74.5 48 108 48T896 971t133.5-21.5 108-48 74.5-48 42-21.5q61 0 111.5 20t85.5 53.5 62 81 43 97.5 26.5 108.5 14 109 3.5 103.5zm-320-893q0 159-112.5 271.5T896 896 624.5 783.5 512 512t112.5-271.5T896 128t271.5 112.5T1280 512z" />
    </symbol>
  </svg>


  <div id="admin-panel" style="display: none">
    <div id='calendar2' style="display:flex">
      <button style="margin:10px 0" onclick='returnBack()' class="fc-button fc-button-primary fc-button-active">返回课程表</button>
      <ul id="admin-messages"></ul>
    </div>
    <div id="config-day-window">
      <form id="config-day" autocomplete="off">
        <div style="display:flex; flex-direction:row;" class="top-level">
          <fieldset style="padding:0 5px">
            <input id="s-time" type="time" name="s-time" min="07:00" max="22:00" required>
          </fieldset>
          <fieldset style="padding:0 0">
            至
          </fieldset>
          <fieldset style="padding:0 5px">
            <input id="e-time" type="time" name="e-time" min="07:00" max="22:00" required>
          </fieldset>
        </div>
        <div style="display:flex; flex-direction:row;" class="bottom-level">
          <fieldset>
            <input onclick="addDay()" type="submit" style="width:80px;cursor:pointer;" id="add-day" value="添加时间">
          </fieldset>
          <fieldset>
            <input onclick="copyDay()" type="button" id="copy-day" style="cursor:pointer;" value="复制">
          </fieldset>
          <fieldset>
            <input onclick="resetDay()" type="button" id="reset-day" style="cursor:pointer;" value="重置">
          </fieldset>
          <fieldset>
            <input onclick="showConfigDayWindow(0);" id="config-window-back" type="button" value="返回">
          </fieldset>
        </div>
      </form>
    </div>
  </div>
</body>
</html>
